jQuery(document).ready(function(g){var f=g("#mailster_iframe"),h=g("#_wpnonce").val(),b=f.data("base"),e=g("#templateeditor"),n=g("textarea.editor"),j=g(".uploadinfo"),a=g("html,body"),c;g("a.external").on("click",function(){if(this.href){window.open(this.href)}return false});g(".upload-template").on("click",function(){g(".upload-field").show()});g("#mailster_templates").on("click",".edit",function(){var s=g(this),t=s.closest(".mailster-box"),o=g(".mailster-box"),q=s.attr("href"),p=s.data("slug");if(s.parent().hasClass("disabled")){return false}o.removeClass("edit");t.addClass("edit");var v=t.data("id");var r=Math.floor((g("#mailster_templates").outerWidth())/(t.width()+22));var u=Math.floor(v/r)*r+r-1;e.find("textarea").val("");e.find("h3").html(t.find("h3").html());e.slideDown();e.insertAfter(o.eq(u).length?o.eq(u):o.last());d(e.offset().top-50);t.removeClass("loading");l(q);return false}).on("change",".template-file-selector-dd",function(){l(g(this).val())}).on("click",".remove-file",function(){var o=g(this);if(confirm(o.data("confirm"))){g("#templateeditor").addClass("loading");i("remove_template",{file:o.data("file")},function(p){g("#templateeditor").removeClass("loading");if(p.success){g(".template-file-selector-dd").find(":selected").prev("option").prop("selected",true).trigger("change")}})}event.stopPropagation();return false}).on("click","a.cancel",function(){e.slideUp();g(".mailster-box").removeClass("edit");return false}).on("click","button.save, button.saveas",function(){var s=g(this),o=g(".template-ajax-loading"),r=c.getValue(),q=g("span.message"),p;if(s.is(".saveas")&&!(p=prompt(mailsterL10n.enter_template_name+":",""))){return false}o.css({display:"inline"}),s.prop("disabled",true);i("set_template_html",{content:r,name:p,slug:g("#slug").val(),file:g("#file").val()},function(t){o.hide();s.prop("disabled",false);if(t.success){q.fadeIn(10).html(t.msg).delay(2000).fadeOut();if(t.newfile){l("mailster/"+t.newfile)}}else{alert(t.msg)}},function(t,v,u){o.hide();s.prop("disabled",false);alert(v+" "+t.status+": "+u+"\n\nCheck the JS console for more info!")});return false}).on("click",".thickbox-preview",function(){var r=g(this),q=r.parent().attr("title"),p=r.data("slug"),o=r.attr("href");g("#thickboxbox").find("iframe").attr("src",o);g(".thickbox-filelist").empty().hide();tb_show(q,"?&width=900&inlineId=thickboxbox&TB_inline",null);g("#TB_window").width(936).height(700).css("margin-left",-936/2).css("margin-top",-700/2);i("get_file_list",{slug:p},function(s){if(s.success){var t="";g.each(s.files,function(u,v){t+="<li>";if("index.html"!=u&&"notification.html"!=u){t+='<a href="" class="thickbox-remove-file mailster-icon" data-slug="'+s.slug+'" data-file="'+u+'"></a>'}t+='<a href="'+s.base+"/"+u+'" class="thickbox-file" style="background-image:url('+v.screenshot+')"></a><span>'+v.label+" ("+u+")</span></li>"});g(".thickbox-filelist").html(t).slideDown()}else{alert(s.msg)}},function(s,u,t){loader.hide();$this.prop("disabled",false);alert(u+" "+s.status+": "+t+"\n\nCheck the JS console for more info!")});return false}).on("click","a.activate",function(){var r=g(this),p="",q=r.data("license")||"",o=r.data("slug");g("#template-"+o).addClass("add-license").find(".license").val(q).focus().select();return false}).on("click","a.download",function(){g(this).prop("disabled",true)}).on("click","a.update",function(){if(confirm(mailsterL10n.update_note)){g(this).closest(".mailster-box").addClass("loading");return true}return false}).on("click","a.deletion",function(){if(confirm(k(mailsterL10n.confirm_delete,g(this).data("name")))){g(this).closest(".mailster-box").addClass("loading");return true}return false}).on("click","a.download, a.activatelink, .save-license",function(){g(this).closest(".mailster-box").addClass("loading")});g(document).on("click","a.thickbox-file",function(){g(".thickbox-iframe").attr("src",g(this).attr("href"));return false}).on("click",".thickbox-remove-file",function(){var r=g(this),q=r.parent(),o=r.data("slug"),p=r.data("file");if(confirm(k(mailsterL10n.delete_template_file,p,o))){q.addClass("loading");i("remove_template",{file:o+"/"+p},function(s){if(s.success){q.slideUp()}else{q.removeClass("loading")}})}event.stopPropagation();return false});var m=function(){var o=new plupload.Uploader(wpUploaderInit);o.bind("Init",function(p){var q=g("#plupload-upload-ui");if(p.features.dragdrop&&!g(document.body).hasClass("mobile")){q.addClass("drag-drop");g("#drag-drop-area").bind("dragover.wp-uploader",function(){q.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){q.removeClass("drag-over")})}else{q.removeClass("drag-drop");g("#drag-drop-area").unbind(".wp-uploader")}if(p.runtime=="html4"){g(".upload-flash-bypass").hide()}});o.init();o.bind("FilesAdded",function(p,q){setTimeout(function(){p.refresh();p.start()},1)});o.bind("BeforeUpload",function(p,q){});o.bind("UploadFile",function(p,q){});o.bind("UploadProgress",function(p,q){j.html(k(mailsterL10n.uploading,q.percent+"%"))});o.bind("Error",function(p,q){j.html(q.message);p.refresh()});o.bind("FileUploaded",function(p,r,q){q=g.parseJSON(q.response);if(q.success){location.reload()}else{j.html(q.error)}});o.bind("UploadComplete",function(p,q){})};if(typeof(wpUploaderInit)=="object"){m()}function l(p){var o=g(".template-ajax-loading").css({display:"inline"});g("#templateeditor").addClass("loading");i("get_template_html",{href:p},function(q){o.hide();g("#templateeditor").removeClass("loading");g("#file").val(q.file);g("#slug").val(q.slug);n.val(q.html);if(!c){var u={name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]};c=CodeMirror.fromTextArea(n.get(0),{mode:u,tabMode:"indent",lineNumbers:true,autofocus:true})}else{c.setValue(q.html)}var r='<select class="template-file-selector-dd">',t=Object.keys(q.files).length,s;g.each(q.files,function(v,w){if(t>1){r+='<optgroup label="'+v+'">'}g.each(w,function(x,y){if(x==q.file){s=y}r+=' <option value="'+q.slug+"/"+x+'" '+(x==q.file?"selected":"")+' data-slug="'+q.slug+'">'+y.label+" ("+x+")</option>"});if(t>1){r+="</optgroup>"}});r+="</select>";if(q.file!="index.html"&&q.file!="notification.html"){r+='<a class="remove-file mailster-icon" data-file="'+q.slug+"/"+q.file+'" data-confirm="'+k(mailsterL10n.delete_template_file,s.label,s.name)+'"></a>'}e.find(".template-file-selector span").html(r)})}function d(p,o){a.animate({scrollTop:p},o&&function(){o()})}function k(){var o=Array.prototype.slice.call(arguments),s=o.shift(),r=o.length,q;for(var p=0;p<r;p++){q=new RegExp("%("+(p+1)+"\\$)?(s|d|f)");s=s.replace(q,o[p])}return s}function i(q,p,r,o){if(g.isFunction(p)){if(g.isFunction(r)){o=r}r=p;p={}}g.ajax({type:"POST",url:ajaxurl,data:g.extend({action:"mailster_"+q,_wpnonce:h},p),success:function(t,u,s){r&&r.call(this,t,u,s)},error:function(s,u,t){if(u=="error"&&!t){return}if(console){console.error(g.trim(s.responseText))}o&&o.call(this,s,u,t)},dataType:"JSON"})}});